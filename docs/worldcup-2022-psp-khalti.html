<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Observation of WorldCup 2022 as a payment service provider</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="http://localhost:8000/worldcup-2022-psp-khalti.html" rel="canonical" />
  <!-- Feed -->

  <link href="http://localhost:8000/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="http://localhost:8000/theme/css/code_blocks/github.css" rel="stylesheet">

    <!-- CSS specified by the user -->


    <link href="http://localhost:8000/assets/css/kwati.css" type="text/css" rel="stylesheet" />

    <!-- Custom fonts -->
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="Due to several factors, our application became unreachable on the FIFA World Cup 2022 opening day. World Cup Football is undoubtedly the...">

    <meta name="author" content="Dhruba Adhikari">
    <meta name="author" content="Aman Maharjan">

    <meta name="tags" content="reflection">
    <meta name="tags" content="downtime">
    <meta name="tags" content="infrastructure">




<!-- Open Graph -->
<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="Bits in Skewers"/>
<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Observation of WorldCup 2022 as a payment service provider"/>
<meta prefix="og: http://ogp.me/ns#" property="og:description" content="Due to several factors, our application became unreachable on the FIFA World Cup 2022 opening day. World Cup Football is undoubtedly the..."/>
<meta prefix="og: http://ogp.me/ns#" property="og:locale" content="en_US"/>
<meta prefix="og: http://ogp.me/ns#" property="og:url" content="http://localhost:8000/worldcup-2022-psp-khalti.html"/>
<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"/>
<meta prefix="og: http://ogp.me/ns#" property="article:published_time" content="2023-03-02 15:00:00+05:45"/>
<meta prefix="og: http://ogp.me/ns#" property="article:modified_time" content=""/>
<meta prefix="og: http://ogp.me/ns#" property="article:author" content="http://localhost:8000/author/dhruba-adhikari.html">
<meta prefix="og: http://ogp.me/ns#" property="article:section" content="reflections"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="reflection"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="downtime"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="infrastructure"/>
<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://localhost:8000/assets/article_images/2023/skewers_missed_goal.jpg">

<!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@khalti">
    <meta name="twitter:title" content="Observation of WorldCup 2022 as a payment service provider">
    <meta name="twitter:url" content="http://localhost:8000/worldcup-2022-psp-khalti.html">

        <meta name="twitter:image:src" content="http://localhost:8000/assets/article_images/2023/skewers_missed_goal.jpg">

      <meta name="twitter:description" content="Due to several factors, our application became unreachable on the FIFA World Cup 2022 opening day. World Cup Football is undoubtedly the...">

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Observation of WorldCup 2022 as a payment service provider",
  "headline": "Observation of WorldCup 2022 as a payment service provider",
  "datePublished": "2023-03-02 15:00:00+05:45",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Dhruba Adhikari",
    "url": "http://localhost:8000/author/dhruba-adhikari.html"
  },
  "image": "http://localhost:8000/assets/article_images/2023/skewers_missed_goal.jpg",
  "url": "http://localhost:8000/worldcup-2022-psp-khalti.html",
  "description": "Due to several factors, our application became unreachable on the FIFA World Cup 2022 opening day. World Cup Football is undoubtedly the..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

  <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v16.0" nonce="imCdLiOX"></script>

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>

              <li role="presentation"><a href="http://localhost:8000/pages/about.html">About this blog</a></li>
              <li role="presentation"><a href="http://localhost:8000/pages/about-khalti.html">About Khalti</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="http://localhost:8000/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">Observation of WorldCup 2022 as a payment service provider</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="http://localhost:8000/author/dhruba-adhikari.html">Dhruba Adhikari</a>
                <a href="http://localhost:8000/author/aman-maharjan.html">Aman Maharjan</a>
            | <time datetime="Thu 02 March 2023">Thu 02 March 2023</time>
        </span>
            <div class="post-cover cover" style="background-image: url('http://localhost:8000/assets/article_images/2023/skewers_missed_goal.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>Due to several factors, our application became unreachable on the FIFA World Cup 2022 opening day. World Cup Football is undoubtedly the planet's biggest sporting phenomenon. </p>
<p>Coincidentally, our national election day and this year's World Cup Football opening match were scheduled on the same day. Even the election was among the prominent news headlines due to the lineup of independent and new candidates.</p>
<p>Leading payment instruments in the country faced a prolonged downtime around the opening match schedules. </p>
<p><img alt="Connections spike distribution" src="assets/article_images/2023/0001.connections.png" title="incoming connections"></p>
<h1>Our Scope as a payment provider</h1>
<p>Due to the Territory Distribution restrictions of FIFA World Cup 2022, customers had to pay 500 Rs + VAT to the MSOs (Multiple Systems Operators) to watch the live matches. There were two major payment requirements, </p>
<ol>
<li>Price for the TV subscription</li>
<li>Price for the world cup channel activation</li>
</ol>
<p>Like other payment service providers, Khalti was also a payment partner integrated with television providers and ISPs. </p>
<p>Football being one of the biggest sporting crazes and World Cup being the most awaited event for football fans, it was sure that the payment requirement would bring some traffic spikes. However, the incoming traffic was much higher than anticipated.  </p>
<h1>The Impact</h1>
<p>During the incident, users reported that the application was either unresponsive or slow in responding to requests. Additionally, some users experienced frequent 500 errors when accessing certain pages or services. We also received reports from users who had successfully made payments for TV channel subscriptions but could not access the channels.</p>
<h1>Investigation</h1>
<p>Upon receiving reports of the incident, our team immediately began investigating the issue. We monitored our application logs and system metrics and found that our servers were experiencing high traffic and requests during the incident. We also observed that some of our servers ran at or near capacity.</p>
<h1>Root Cause Analysis</h1>
<p>Our investigation revealed that the incident's root cause was a sudden surge in traffic. We had configured our WAF (Web Application Firewall) to drop traffic above a certain DDoS threshold. However, this threshold seemed too low for the surge in traffic during the event, resulting in drops in many legitimate requests.</p>
<p>Second, although we had increased the capacity of our application processes and threads in anticipation of the increased traffic, we underestimated the number of concurrent requests generated during peak periods. This lower estimation resulted in our application servers becoming overloaded and unable to respond to new server requests.</p>
<p>Finally, the increased traffic also led to a high number of database connections, which exceeded the capacity of our database server. The increased number of active DB connections caused delays in processing requests and resulted in timeouts and errors.</p>
<h1>Resolution steps taken</h1>
<p>To address the above issues, we took the following steps:
We increased the DDoS threshold on our WAF to a level that could handle the expected traffic during peak periods.
We further scaled up the capacity of our application processes and threads to handle more concurrent requests.
We also increased the connection capacity of our database server to manage handling a higher number of socket connections. We improved our database queries' efficiency to reduce the server's load.
We horizontally scaled our application nodes by adding more nodes to the cluster. This action allowed us to distribute the load across multiple nodes and handle a higher number of concurrent requests.</p>
<h2>Major events during the downtime</h2>
<h3>17:15 Hours</h3>
<p>The system started reporting the first spike in traffic.</p>
<h3>17:43 Hours</h3>
<p>The system activated an automatic DDoS protection rule due to reaching the pre-configured TPS threshold, thus activating a captcha challenge for all requests after that as part of the configured mitigation. The threshold limit was subsequently increased by ten times by an on-duty engineer to address the spike in traffic.</p>
<h3>19:23 Hours</h3>
<p>Traffic spiked to surpass the new threshold again. We reconfigured the TPS threshold to sustain 20 times the organic traffic.</p>
<h3>19:40 Hours</h3>
<p>Application nodes started to hit their traffic limits. We then increased the application processes and threads also. </p>
<p>After raising the DDoS threshold and allowing more requests to pass through to the application nodes, the system monitor indicated more server-side errors and gateway timeouts. As a result, the team quickly started planning for horizontal scaling of the application nodes and began working on it. Additionally, we arranged to double the processes and thread capacities of the web server gateways.</p>
<h3>19:55 Hours</h3>
<p>After we increased the process and thread capacity of the web server gateways, the database then reached its connection limits. We reconfigured the limit with a five times more threshold.</p>
<h3>20:20 Hours</h3>
<p><em>System Load Shedding plan</em> activated. 
During this, as per our policy, services are in high demand, and services consumed by applications for marketing and promotional activities are all disabled.</p>
<h3>23:50 Hours</h3>
<p>We increased the number of application and worker nodes by 200 %</p>
<p><img alt="Connections spike distribution" src="assets/article_images/2023/0001.scaling.png">
Fig, scaling</p>
<h2>Preventions for the future</h2>
<p>Moving forward, we shall be implementing several measures to prevent similar incidents from occurring in the future:</p>
<ol>
<li>We had initially planned to extend our infrastructure to a <strong>High-Availability Data Center</strong>. Due to this incident, we decided to expedite the process and expect to go live with a Data Center pair by the end of August 2023.</li>
<li>We also decided to deploy more observability metrics for better preparedness for such traffic anticipations in the future.</li>
</ol>
<p>On an ending note,
We admit that it was a matter of utter inconvenience and dissatisfaction for the customers we intended to serve as a service provider. However, this became an important milestone for us and the industry. We have pulled our future scaling plans forward, activating both short-term and long-term remediations to prevent such an incident from happening. </p>
<p>Here we are, with a responsible disclosure and a promise towards better service delivery in the coming days. </p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=Observation of WorldCup 2022 as a payment service provider&amp;url=http://localhost:8000/worldcup-2022-psp-khalti.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:8000/worldcup-2022-psp-khalti.html" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="http://localhost:8000/tag/reflection.html">reflection</a><a href="http://localhost:8000/tag/downtime.html">downtime</a><a href="http://localhost:8000/tag/infrastructure.html">infrastructure</a>                </aside>

                <div class="clear"></div>


                </section>


<div class="fb-comments" data-href="http://localhost:8000/worldcup-2022-psp-khalti.html" data-width="100%" data-numposts="10"></div>

                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="http://localhost:8000/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0K4GR3CZ37"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0K4GR3CZ37', { 'anonymize_ip': true });
    </script>
</body>
</html>